---
import Layout from '../layouts/Layout.astro';
import { getPrintifyData, getPrintifyProducts } from '../lib/printify';
import { toSlug } from '../lib/utils';
import HeroBanner from '../components/HeroBanner.vue';
import ProductCard from '../components/ProductCard.vue';

const shopsResponse = await getPrintifyData();
const shops = shopsResponse.success ? shopsResponse.data : [];

const categoriesWithData = await Promise.all(
    shops.map(async (shop) => {
      const productsResponse = await getPrintifyProducts(shop.id);
      const visibleProducts = productsResponse.success
          ? productsResponse.products.filter(p => p.visible)
          : [];

      const firstVisibleProduct = visibleProducts.length > 0 ? visibleProducts[0] : null;

      const imageUrl = firstVisibleProduct
          ? firstVisibleProduct.images.find(img => img.is_default)?.src || firstVisibleProduct.images[0]?.src
          : '/src/assets/placeholder.png';

      return {
        title: shop.title,
        slug: toSlug(shop.title),
        imageSrc: imageUrl,
        // Add a count of visible products to use for filtering
        productCount: visibleProducts.length
      };
    })
);

// Only include categories that have one or more visible products
const visibleCategories = categoriesWithData.filter(category => category.productCount > 0);
---

<Layout title="Smalltime - Welcome to the Shop">
  <HeroBanner
      client:load
      title="Welcome to Smalltime"
      description="Unique designs on quality products. Find your new favorite thing."
      buttonText="Explore All Products"
  />

  <div class="category-grid-container">
    <h2>Shop by Category</h2>
    {visibleCategories.length > 0 ? (
        <ul class="product-grid">
          {visibleCategories.map(category => (
              <li>
                <ProductCard
                    client:visible
                    title={category.title}
                    imageSrc={category.imageSrc}
                    href={`/category/${category.slug}`}
                />
              </li>
          ))}
        </ul>
    ) : (
        <p class="error-message">
          No product categories are available at this time.
        </p>
    )}
  </div>
</Layout>

<style>
  .category-grid-container {
    max-width: 1200px;
    margin: 3rem auto;
    padding: 0 2rem;
    text-align: center;
  }
  .product-grid {
    list-style: none;
    padding: 0;
    margin-top: 2rem;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
  }
  .error-message {
    color: #991b1b;
    background-color: #fef2f2;
    padding: 1rem;
    border-radius: 8px;
  }
</style>