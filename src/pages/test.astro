---
import Layout from '../layouts/Layout.astro';
import { getPrintifyData } from '../lib/printify';
import ApiResult from '../components/ApiResult.vue';
import PrintifyTester from '../components/PrintifyTester.vue';

// Fetch initial data on the server
const initialResult = await getPrintifyData();
const { success, error, ...initialData } = initialResult;
---
<Layout title="Test - Printify Integration">
  <h1>Printify API Test</h1>

  <div style="margin: 2rem 0;">
    <h2>Initial Server-Side Result</h2>
    <p>This data was fetched on the server when the page was generated.</p>

    <ApiResult
        client:visible
        status={success ? 'success' : 'error'}
        data={initialData}
        errorMessage={error}
    />

    {success && (
        <details style="margin-top: 1rem;">
          <summary>View Full Server Response</summary>
          <pre>{JSON.stringify(initialData.data, null, 2)}</pre>
        </details>
    )}

    {error && (
        <p><small>Check your server console and make sure your .env file has PRINTIFY_API_TOKEN set.</small></p>
    )}
  </div>

  <hr style="margin: 2rem 0;" />

  <PrintifyTester client:load />

  <style is:global>
    pre {
      background: #f5f5f5;
      padding: 1rem;
      overflow: auto;
      border-radius: 4px;
      white-space: pre-wrap;
    }
  </style>
</Layout>